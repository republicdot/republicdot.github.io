<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta property="og:title" content="RepublicDot">
    <meta property="og:site_name" content="RepublicDot">
    <meta property="og:description" content="RepublicDot company website">

    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">

    <!-- CSS Reset -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.css">

    <!-- Milligram CSS minified -->
    <link rel="stylesheet" href="css/milligram.min.css">
    <link rel="stylesheet" href="css/main.css">

    <title>RepublicDot</title>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <div class="container">
      <div class="row">
        <div class="column">
          <img class='head-logo' src="img/logo_black.svg" alt="RepublicDot Logo">
          <p class="title">
            당신을 위한 3세대 콘텐츠 커뮤니티
          </p>
          <p>
            <span class="date">9.19</span>
            <br />
            리뷰가 영원히 바뀝니다.
          </p>
          <p class="form-desc">
            사전등록 (현재 <span id="apply-num">...</span> 명)
          </p>
        </div>
      </div>
      <div class="row">
        <div class="column form">
          <div class="loading"></div>
          <div id="error-load-api" class="error" id="help">
            야생의 보노보노가 나타나 신청을 방해하였다.
            &nbsp;&nbsp;
            <a id="re-load-api">다시 시도</a>
          </div>
          <div id="error" class="error" id="help">
            야생의 보노보노가 나타나 신청을 방해하였다.
            &nbsp;&nbsp;
            <a id="re-apply">다시 시도</a>
          </div>
          <form id="form">
            <fieldset>
              <input type="text" placeholder="Email" id="q1Field" />
              <div class="help" id="help-q1">
              </div>
              <textarea placeholder="Comment (10자 이상)" id="q2Field"></textarea>
              <div class="help" id="help-q2">
              </div>
              <button id="submit-button" class="button-primary" type="button" onclick="handleSendClick(event)">Send</button>
            </fieldset>
          </form>
        </div>
      </div>
    </div>
    <footer>
      <a class="facebook-link" href="https://www.facebook.com/RepublicDot/" target="_blank">facebook</a>
    </footer>
    <div id="feedback">
      신청이 완료되었습니다.
    </div>
    <iframe src="#" id="no-target" name="no-target" style="visibility:hidden"></iframe>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    <script type="text/javascript" src="js/background.js"></script>
    <script type="text/javascript">

    var CLIENT_ID = '77785196753-ppvnddomaq0i35pglsganqq6etuvscbq.apps.googleusercontent.com';
    var SCOPES = ["https://www.googleapis.com/auth/spreadsheets"];
    var SPREADSHEET_ID = '1-cVEfm0L99dY2x2wRyvytmRsU3qO756g9UYKx_uravI';
    var API_KEY = 'AIzaSyBOp1McIXyjaia1iAkG_b-G1d8WQmUgh2w';
    var discoveryUrl =
        'https://sheets.googleapis.com/$discovery/rest?version=v4';

    /**
     * Load Sheets API client library.
     */
    function loadSheetsApi() {
      gapi.client.setApiKey(API_KEY);
      gapi.client.load(discoveryUrl).then(loadTotalApplyCount);
    }

    function getTotalApplyCount(cb) {
      gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: 'response!A2:C'
      }).then(function(response) {
        var range = response.result;
        cb(null, range.values.length);
      }, function(response) {
        cb(response.result.error);
      });
    }

    function loadTotalApplyCount () {
      getTotalApplyCount(function(error, result) {
        if (error) {
          $(".loading").hide();
          $("#error-load-api").fadeIn();
          $("#apply-num").html('xx')
        } else {
          $(".loading").hide();
          $("#form").fadeIn();
          $("#apply-num").html(result)
        }
      });
    }

    function validateForm(q1, q2) {
      if (q1.length === 0) {
        $("#help-q1").html("Email은 필수입력 항목입니다.").show();
        return false;
      }
      if (q2.length < 10) {
        $("#help-q2").html("Comment는 10자 이상 써주셔야 합니다.").show();
        return false;
      }
      return true;
    }

    function handleSendClick(event) {
      var q1 = $('#q1Field').val();
      var q2 = $('#q2Field').val();

      $("#error").hide();
      $("#help-q1").hide();
      $("#help-q2").hide();

      if (validateForm(q1, q2)) {
        gapi.auth.authorize(
          {client_id: CLIENT_ID, scope: SCOPES, immediate: false},
          handleAuthResult);
      }

      return false;
    }

    /**
     * Handle response from authorization server.
     *
     * @param {Object} authResult Authorization result.
     */
    function handleAuthResult(authResult) {
      if (authResult && !authResult.error) {
        $("#error").hide();
        gapi.client.load(discoveryUrl).then(addRowToGoogleSheets);
      } else {
        $("#error").show();
      }
    }

    function addRowToGoogleSheets() {
      var q1 = $('#q1Field').val();
      var q2 = $('#q2Field').val();

      var $submitButton = $("#submit-button");
      var $loading = $("<div class='loading'></div>");

      $submitButton.html("");
      $submitButton.append($loading);

      gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SPREADSHEET_ID,
        range: 'response!A1:D1',
        valueInputOption: 'USER_ENTERED'
      }, {
        "values": [
          [new Date(), q1, q2]
        ],
      }).then(function(r) {
        $loading.remove();
        $submitButton.html("Send");
        $("#q1Field").val('');
        $("#q2Field").val('');
        $("#error").hide();
        $("#help-q1").hide();
        $("#help-q2").hide();

        $("#feedback").fadeIn();
        setTimeout(function(){$("#feedback").fadeOut();}, 5000);
      }, function(e) {
        $loading.remove();
        $submitButton.html("Send");
        $("#error").show();
      });
    }

    $(function() {
      $("#re-apply").click(function() {
        $("#error").hide();
        $("#submit-button").trigger("click");
      });

      $("#re-apply").click(function() {
        $("#error-load-api").hide();
        loadSheetsApi();
      });
    });
    </script>
    <script src="https://apis.google.com/js/client.js?onload=loadSheetsApi"></script>
  </body>
</html>
